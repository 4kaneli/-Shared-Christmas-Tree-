<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shared Christmas Tree ðŸŽ„</title>
<style>
html, body {
    margin:0; padding:0;
    width:100%; height:100%;
    font-family: Arial, sans-serif;
    overflow:hidden;
}
body {
    background: url('tree.png') no-repeat center center;
    background-size: cover;
    position: relative;
}
.panel {
    position: absolute;
    top:20px; left:20px;
    width: 300px;
    background: rgba(0,0,0,0.5);
    padding: 15px;
    border-radius: 10px;
    color:#fff;
}
.panel h1 { font-size: 20px; margin:0 0 10px; }
.panel input { width:100%; padding:8px; margin-top:5px; border-radius:6px; border:none; font-size:14px;}
.panel button { margin-top:8px; padding:8px 10px; border:none; border-radius:6px; background:#ffb547; cursor:pointer; font-weight:bold; }
.panel .list { margin-top:10px; max-height:200px; overflow:auto; background: rgba(255,255,255,0.1); padding:5px; border-radius:6px; }
.panel .list div { margin-bottom:5px; padding:5px; background: rgba(0,0,0,0.2); border-radius:4px; }
.ball {
    position:absolute; width:45px; height:45px;
    border-radius:50%; display:flex; justify-content:center; align-items:center;
    font-size:11px; font-weight:bold; color:#fff; cursor:grab;
    box-shadow:0 3px 6px rgba(0,0,0,0.4); border:2px solid rgba(255,255,255,0.2); user-select:none;
}
.snow {
    position:absolute; width:6px; height:6px; background:white; border-radius:50%;
    opacity:0.8; pointer-events:none;
}

/* âœ¨ SCINTILLE */
.sparkle {
    position: absolute;
    width: 6px;
    height: 6px;
    background: radial-gradient(white, rgba(255,255,255,0));
    border-radius: 50%;
    pointer-events: none;
}

#playMusicBtn {
    position:absolute;
    top:20px;
    
    /* spostamento verso sinistra */
    right:auto;      /* rimuove la posizione a destra */
    left:80px;       /* ora Ã¨ come il pannello */
    top:280px;

    /* ingrandimento */
    padding:18px 28px;
    font-size:20px;
    
    background:#f1c40f;
    border:none;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
}

</style>
</head>
<body>

<button id="playMusicBtn">Christmas song? ðŸŽµ </button>

<div class="panel">
    <h1>Shared Christmas TreeðŸŽ„ </h1>
    <input id="nameInput" placeholder="Enter your nameâ€¦" />
    <button id="addBtn">Add a bauble!</button>
    <div class="list" id="namesList"></div>
    <div style="font-size:12px;margin-top:5px;opacity:0.8;">DB: <code id="dbUrl"></code></div>
</div>

<script>
// Musica di sottofondo
const audio = new Audio('song.wav');
audio.loop = true;

document.getElementById('playMusicBtn').onclick = () => {
    audio.play().catch(()=>console.log("Musica bloccata, serve click dell'utente"));
    document.getElementById('playMusicBtn').style.display='none';
};

// DATABASE FIREBASE
const BASE_DB = "https://christmas-tree-ef839-default-rtdb.firebaseio.com";
document.getElementById('dbUrl').textContent = BASE_DB + "/";
const BALLS_ENDPOINT = BASE_DB + "/balls.json";

// Spawn point
let spawnX = window.innerWidth * 0.75; 
let spawnY = window.innerHeight * 0.4;

// colori vivaci
function colorFromName(name){
    const colors=["#e74c3c","#f1c40f","#9b59b6","#1abc9c","#e67e22","#3498db","#ff6b6b"];
    let n=0; for(let i=0;i<name.length;i++) n=(n*31+name.charCodeAt(i))>>>0;
    return colors[n % colors.length];
}

// salva posizione
async function savePosition(id,x,y){
    try{
        await fetch(`${BASE_DB}/balls/${id}.json`,{
            method:"PATCH",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({x:x,y:y})
        });
    }catch(err){ console.error(err); }
}

/* âœ¨ EFFETTO SCINTILLE */
function createSparkleEffect(x, y) {
    const count = 45;

    for (let i = 0; i < count; i++) {
        const s = document.createElement('div');
        s.className = 'sparkle';

        s.style.left = x + 'px';
        s.style.top = y + 'px';

        document.body.appendChild(s);

        const angle = Math.random() * Math.PI * 2;
        const distance = 20 + Math.random() * 30;

        const destX = x + Math.cos(angle) * distance;
        const destY = y + Math.sin(angle) * distance;

        const duration = 300 + Math.random() * 400;

        s.animate([
            { transform: 'translate(0,0)', opacity: 1 },
            { transform: `translate(${destX - x}px, ${destY - y}px)`, opacity: 0 }
        ], {
            duration: duration,
            easing: 'ease-out'
        }).onfinish = () => s.remove();
    }
}

// crea pallina draggable 1 volta
function createBall(id,name,x,y,fixed=false){
    const ball = document.createElement('div');
    ball.className='ball';
    ball.textContent=name;
    ball.dataset.id=id;
    ball.style.left=x+'px';
    ball.style.top=y+'px';
    ball.style.background=colorFromName(name);
    document.body.appendChild(ball);

    // âœ¨ scintille quando la pallina nasce
    if (!fixed) {
        createSparkleEffect(x + 22, y + 22);
    }

    if(!fixed){
        ball.onmousedown=function(e){
            e.preventDefault();
            let shiftX = e.clientX - ball.getBoundingClientRect().left;
            let shiftY = e.clientY - ball.getBoundingClientRect().top;

            function moveAt(pageX,pageY){
                let newX = pageX - shiftX;
                let newY = pageY - shiftY;
                if(newX<0) newX=0;
                if(newY<0) newY=0;
                if(newX>window.innerWidth-ball.offsetWidth) newX=window.innerWidth-ball.offsetWidth;
                if(newY>window.innerHeight-ball.offsetHeight) newY=window.innerHeight-ball.offsetHeight;
                ball.style.left=newX+'px';
                ball.style.top=newY+'px';
            }

            function onMouseMove(e){ moveAt(e.pageX,e.pageY); }
            document.addEventListener('mousemove',onMouseMove);

            document.onmouseup=function(){
                document.removeEventListener('mousemove',onMouseMove);
                document.onmouseup=null;
                savePosition(ball.dataset.id, parseFloat(ball.style.left), parseFloat(ball.style.top));
                ball.onmousedown=null;
                ball.style.cursor='default';
                createHeavySnow();
            };
        };
    } else ball.style.cursor='default';
}

function createHeavySnow() {
    const flakesCount = 250;
    for (let i = 0; i < flakesCount; i++) {
        const snow = document.createElement('div');
        snow.className = 'snow';
        snow.style.left = Math.random() * window.innerWidth + 'px';
        snow.style.top = -20 - Math.random() * 50 + 'px';
        snow.style.width = 6 + Math.random() * 10 + 'px';
        snow.style.height = snow.style.width;
        snow.style.opacity = 0.7 + Math.random() * 0.3;
        document.body.appendChild(snow);

        const duration = 3000 + Math.random() * 3000;
        snow.animate([
            { transform: 'translateY(0px) rotate(0deg)', opacity: snow.style.opacity },
            { transform: `translateY(${window.innerHeight}px) rotate(${Math.random()*360}deg)`, opacity: 0 }
        ],{
            duration: duration,
            iterations: 1
        }).onfinish = () => snow.remove();
    }
}

// render palline
function renderBalls(ballsObj){
    document.querySelectorAll('.ball').forEach(b=>b.remove());
   const entries = ballsObj ? Object.entries(ballsObj) : [];
const list = document.getElementById('namesList');
list.innerHTML = '';

entries.forEach(([id,data])=>{
    let x = data.x!==undefined?data.x: spawnX;
    let y = data.y!==undefined?data.y: spawnY;
    createBall(id,data.name,x,y,data.x!==undefined && data.y!==undefined);
});

// mostra solo lâ€™ultimo nome
if (entries.length > 0) {
    const last = entries[entries.length - 1][1];
    const item = document.createElement('div');
    item.textContent = last.name;
    list.appendChild(item);
}
}

// fetch + polling
let lastData=null;
async function fetchBalls(){
    try{
        const res = await fetch(BALLS_ENDPOINT);
        const json = await res.json();
        const str = JSON.stringify(json||{});
        if(str!==lastData){
            lastData=str;
            renderBalls(json);
        }
    }catch(err){ console.error(err); }
}

// aggiungi pallina
async function addBallToDB(name){
    try{
        const payload={name:name,createdAt:Date.now()};
        await fetch(BALLS_ENDPOINT,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(payload)
        });
        fetchBalls();
    }catch(err){ alert("Errore durante l'aggiunta"); }
}

// eventi UI
document.getElementById('addBtn').onclick=()=>{
    const name=document.getElementById('nameInput').value.trim();
    if(!name) return alert("Scrivi un nome!");
    addBallToDB(name);
    document.getElementById('nameInput').value="";
};
document.getElementById('nameInput').addEventListener('keypress',e=>{
    if(e.key==="Enter") document.getElementById('addBtn').click();
});

// polling
fetchBalls();
setInterval(fetchBalls,2000);

</script>
</body>
</html>
